<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exfoliator Control Interface</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #111827;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            padding: 24px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .title {
            font-size: 2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status {
            padding: 8px 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .status.connected { background-color: #059669; }
        .status.disconnected { background-color: #DC2626; }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: white;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
        }
        
        .card {
            background-color: #1F2937;
            border-radius: 12px;
            padding: 24px;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title {
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .btn-primary { background-color: #2563EB; color: white; }
        .btn-secondary { background-color: #4B5563; color: white; }
        .btn-danger { background-color: #DC2626; color: white; }
        .btn-success { background-color: #059669; color: white; }
        .btn-warning { background-color: #F59E0B; color: white; }
        .btn-emergency {
            background-color: #DC2626;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 12px 24px;
            border: 3px solid #B91C1C;
            transition: all 0.3s ease;
        }
        
        .btn-emergency:hover {
            background-color: #B91C1C;
            transform: none;
        }
        
        .btn-emergency.estop-active {
            animation: flashRed 1s ease-in-out infinite alternate;
        }
        
        @keyframes flashRed {
            0% { 
                background-color: #DC2626; 
                border-color: #B91C1C;
                box-shadow: 0 0 10px #DC2626;
            }
            100% { 
                background-color: #EF4444; 
                border-color: #DC2626;
                box-shadow: 0 0 20px #EF4444;
            }
        }
        
        .emergency-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 24px;
            gap: 8px;
        }
        
        .restart-message {
            color: #EF4444;
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .input {
            width: 100%;
            padding: 8px 12px;
            background-color: #374151;
            border: 1px solid #4B5563;
            border-radius: 6px;
            color: white;
        }
        
        .flex {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .flex-col {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .mb-4 { margin-bottom: 16px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-2 { margin-bottom: 8px; }
        
        .temp-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .temp-current {
            font-size: 1.5rem;
            font-weight: bold;
            color: #EF4444;
        }
        
        .console {
            background-color: #000;
            border-radius: 6px;
            padding: 12px;
            height: 120px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.875rem;
        }
        
        .console-line {
            color: #10B981;
            margin-bottom: 2px;
        }
        
        .chart-container {
            height: 250px;
            margin-bottom: 16px;
        }
        
        .pneumatic-control {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 12px;
            background-color: #374151;
            border-radius: 6px;
        }
        
        .pneumatic-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #DC2626;
        }
        
        .status-indicator.active {
            background-color: #10B981;
        }
        
        .motor-state {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .state-disabled { background-color: #6B7280; color: white; }
        .state-enabling { background-color: #F59E0B; color: white; }
        .state-faulted { background-color: #DC2626; color: white; }
        .state-ready { background-color: #059669; color: white; }
        .state-moving { background-color: #3B82F6; color: white; }
        
        .position-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px 12px;
            background-color: #374151;
            border-radius: 6px;
        }
        
        .tape-control-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .tape-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .tape-input-label {
            font-size: 0.875rem;
            color: #D1D5DB;
        }
        
        .tape-time-control {
            display: flex;
            gap: 8px;
            align-items: end;
        }
        
        .tape-time-input {
            flex: 1;
        }
        
        .tape-state-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px 12px;
            background-color: #374151;
            border-radius: 6px;
        }
        
        /* New macro styles */
        .macro-variables {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .macro-variable-input {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .macro-list {
            max-height: 200px;
            overflow-y: auto;
            background-color: #374151;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 16px;
        }
        
        .macro-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 8px;
            background-color: #1F2937;
            border-radius: 4px;
        }
        
        .macro-item:last-child {
            margin-bottom: 0;
        }
        
        .macro-name {
            font-weight: 500;
            flex-grow: 1;
        }
        
        .macro-actions {
            display: flex;
            gap: 4px;
        }
        
        .macro-actions button {
            padding: 4px 8px;
            font-size: 0.875rem;
        }
        
        .macro-editor {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1F2937;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        }
        
        .macro-editor.active {
            display: block;
        }
        
        .macro-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .macro-editor textarea {
            width: 100%;
            height: 400px;
            background-color: #000;
            color: #10B981;
            font-family: monospace;
            font-size: 0.875rem;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #4B5563;
            resize: vertical;
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 999;
        }
        
        .overlay.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; align-items: center; gap: 16px;">
                <h1 class="title">
                    <span>üî¨</span>
                    Exfoliator Control Interface
                </h1>
            </div>
            <div id="connectionStatus" class="status disconnected">
                <div class="status-dot"></div>
                <span>Disconnected</span>
            </div>
        </div>

        <!-- Emergency Stop -->
        <div class="emergency-container">
            <button id="emergencyButton" class="button btn-emergency" onclick="emergencyStop()">üõë EMERGENCY STOP</button>
            <div id="restartMessage" class="restart-message" style="display: none;">
                ‚ö†Ô∏è RESTART MACHINE ‚ö†Ô∏è
            </div>
        </div>

        <div class="grid">
            <!-- Position Controls -->
            <div class="card">
                <h2 class="card-title">
                    <span>üìç</span>
                    Position Control
                </h2>
                
                <!-- Current Position -->
                <div class="mb-4">
                    <h3 class="section-title">Current Position</h3>
                    <div class="position-display">
                        <span>X Position:</span>
                        <div style="display: flex; align-items: center;">
                            <span id="posX">0.0 mm</span>
                            <span id="motorStateX" class="motor-state state-disabled">MOTOR_DISABLED</span>
                        </div>
                    </div>
                    <div class="position-display">
                        <span>Y Position:</span>
                        <div style="display: flex; align-items: center;">
                            <span id="posY">0.0 mm</span>
                            <span id="motorStateY" class="motor-state state-disabled">MOTOR_DISABLED</span>
                        </div>
                    </div>
                </div>
                
                <!-- Enable Controls -->
                <div class="mb-4">
                    <h3 class="section-title">
                        <span>üîå</span>
                        Motor Enable
                    </h3>
                    <div class="button-grid">
                        <button class="button btn-success" onclick="enableAxis('X')">Enable X</button>
                        <button class="button btn-success" onclick="enableAxis('Y')">Enable Y</button>
                        <button class="button btn-danger" onclick="disableMotor('X')">Disable X</button>
                        <button class="button btn-danger" onclick="disableMotor('Y')">Disable Y</button>
                    </div>
                </div>

                <!-- Move to Position -->
                <div>
                    <h3 class="section-title">Move to Position</h3>
                    <div class="mb-3">
                        <label class="text-sm">X Position (mm)</label>
                        <input type="number" id="xPositionInput" class="input" value="0" step="0.1">
                        <button class="button btn-success mb-2" onclick="moveToPosition('X')">Move X</button>
                    </div>
                    <div class="mb-3">
                        <label class="text-sm">Y Position (mm)</label>
                        <input type="number" id="yPositionInput" class="input" value="0" step="0.1">
                        <button class="button btn-success" onclick="moveToPosition('Y')">Move Y</button>
                    </div>
                </div>
            </div>

            <!-- Pneumatics Control -->
            <div class="card">
                <h2 class="card-title">
                    <span>üí®</span>
                    Pneumatic Controls
                </h2>
                
                <!-- Nozzle -->
                <div class="pneumatic-control">
                    <div class="pneumatic-status">
                        <div id="nozzleStatus" class="status-indicator"></div>
                        <span>Nozzle</span>
                    </div>
                    <div class="flex">
                        <button class="button btn-success" onclick="controlPneumatic('nozzle', 'extend')">Extend</button>
                        <button class="button btn-danger" onclick="controlPneumatic('nozzle', 'retract')">Retract</button>
                    </div>
                </div>

                <!-- Chip Stage -->
                <div class="pneumatic-control">
                    <div class="pneumatic-status">
                        <div id="stageStatus" class="status-indicator"></div>
                        <span>Chip Stage</span>
                    </div>
                    <div class="flex">
                        <button class="button btn-success" onclick="controlPneumatic('stage', 'extend')">Extend</button>
                        <button class="button btn-danger" onclick="controlPneumatic('stage', 'retract')">Retract</button>
                    </div>
                </div>

                <!-- Stamp -->
                <div class="pneumatic-control">
                    <div class="pneumatic-status">
                        <div id="stampStatus" class="status-indicator"></div>
                        <span>Stamp</span>
                    </div>
                    <div class="flex">
                        <button class="button btn-success" onclick="controlPneumatic('stamp', 'extend')">Extend</button>
                        <button class="button btn-danger" onclick="controlPneumatic('stamp', 'retract')">Retract</button>
                    </div>
                </div>

                <!-- Vacuum Controls -->
                <div>
                    <h3 class="section-title">
                        <span>üå™Ô∏è</span>
                        Vacuum Controls
                    </h3>
                    
                    <!-- Vacuum Nozzle -->
                    <div class="pneumatic-control">
                        <div class="pneumatic-status">
                            <div id="vacnozzleStatus" class="status-indicator"></div>
                            <span>Nozzle</span>
                        </div>
                        <div class="flex">
                            <button class="button btn-success" onclick="controlVacuum('vacnozzle', 'on')">On</button>
                            <button class="button btn-danger" onclick="controlVacuum('vacnozzle', 'off')">Off</button>
                        </div>
                    </div>

                    <!-- Chuck Vacuum -->
                    <div class="pneumatic-control">
                        <div class="pneumatic-status">
                            <div id="chuckStatus" class="status-indicator"></div>
                            <span>Chuck</span>
                        </div>
                        <div class="flex">
                            <button class="button btn-success" onclick="controlVacuum('chuck', 'on')">On</button>
                            <button class="button btn-danger" onclick="controlVacuum('chuck', 'off')">Off</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tape Motor Control -->
            <div class="card">
                <h2 class="card-title">
                    <span>üéûÔ∏è</span>
                    Tape Motor Control
                </h2>
                
                <!-- Current Tape State -->
                <div class="mb-4">
                    <h3 class="section-title">Current State</h3>
                    <div class="tape-state-display">
                        <span>Speed:</span>
                        <span id="currentTapeSpeed">0</span>
                    </div>
                    <div class="tape-state-display">
                        <span>Torque:</span>
                        <span id="currentTapeTorque">0</span>
                    </div>
                </div>

                <!-- Tape Motor Controls -->
                <div>
                    <h3 class="section-title">Set Parameters</h3>
                    <div class="tape-control-grid">
                        <div class="tape-input-group">
                            <label class="tape-input-label">Speed</label>
                            <input type="number" id="tapeSpeed" class="input" value="0">
                        </div>
                        <div class="tape-input-group">
                            <label class="tape-input-label">Torque</label>
                            <input type="number" id="tapeTorque" class="input" value="0">
                        </div>
                    </div>
                    <div class="tape-time-control">
                        <div class="tape-input-group tape-time-input">
                            <label class="tape-input-label">Duration (ms)</label>
                            <input type="number" id="tapeTime" class="input" value="1000">
                        </div>
                        <button class="button btn-primary" onclick="runTapeMotor()">Send Command</button>
                        <button class="button btn-danger" onclick="stopTapeMotor()">Stop Tape</button>
                    </div>
                </div>
            </div>

            <!-- Temperature Control -->
            <div class="card">
                <h2 class="card-title">
                    <span>üå°Ô∏è</span>
                    Chip Temperature Control
                </h2>
                
                <div class="temp-display mb-3">
                    <span>Current Temperature:</span>
                    <span id="currentTemp" class="temp-current">0¬∞C</span>
                </div>
                
                <div class="temp-display mb-3">
                    <span>Target Temperature:</span>
                    <span id="targetTemp" class="temp-current" style="color: #F59E0B;">0¬∞C</span>
                </div>
                
                <div class="flex mb-3">
                    <input type="number" id="tempInput" class="input" value="0" min="0" max="300">
                    <button class="button btn-danger" onclick="setTemperature()">Set Temp</button>
                </div>

                <!-- Temperature Chart -->
                <div class="chart-container">
                    <canvas id="tempChart"></canvas>
                </div>
            </div>

            <!-- Macro Control -->
            <div class="card">
                <h2 class="card-title">
                    <span>üé¨</span>
                    Macro Control
                </h2>
                
                <!-- Variables Section -->
                <div class="mb-4">
                    <h3 class="section-title">Position Variables</h3>
                    <div class="macro-variables">
                        <div class="macro-variable-input">
                            <label class="tape-input-label">CHIP_X</label>
                            <input type="number" id="CHIP_X" class="input" value="105.5" step="0.1">
                        </div>
                        <div class="macro-variable-input">
                            <label class="tape-input-label">CHIP_Y</label>
                            <input type="number" id="CHIP_Y" class="input" value="4.5" step="0.1">
                        </div>
                        <div class="macro-variable-input">
                            <label class="tape-input-label">STAGE_X</label>
                            <input type="number" id="STAGE_X" class="input" value="8" step="0.1">
                        </div>
                    </div>
                </div>
                
                <!-- Macro List -->
                <div class="mb-4">
                    <h3 class="section-title">Saved Macros</h3>
                    <div id="macroList" class="macro-list">
                        <!-- Macros will be populated here -->
                        <div style="color: #6B7280; text-align: center; padding: 20px;">No macros saved yet</div>
                    </div>
                </div>
                
                <!-- New Macro -->
                <div>
                    <div class="flex mb-2">
                        <input type="text" id="newMacroName" class="input" placeholder="Enter macro name...">
                        <button class="button btn-success" onclick="createNewMacro()">Create New</button>
                    </div>
                </div>
            </div>

            <!-- Console -->
            <div class="card">
                <h2 class="card-title">
                    <span>üíª</span>
                    Console
                </h2>
                <div id="console" class="console">
                    <div class="console-line">Machine control interface ready...</div>
                </div>
                
                <div class="flex mt-3">
                    <input type="text" id="customCommand" class="input" placeholder="Enter custom command...">
                    <button class="button btn-primary" onclick="sendCustomCommand()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Macro Editor Modal -->
    <div class="overlay" id="overlay" onclick="closeMacroEditor()"></div>
    <div class="macro-editor" id="macroEditor">
        <div class="macro-editor-header">
            <h2>Edit Macro: <span id="editingMacroName"></span></h2>
            <button class="button btn-danger" onclick="closeMacroEditor()">Close</button>
        </div>
        <textarea id="macroContent" placeholder="Enter macro commands..."></textarea>
        <div class="flex" style="margin-top: 16px; justify-content: flex-end;">
            <button class="button btn-primary" onclick="saveMacro()">Save Macro</button>
        </div>
    </div>

    <script>
        // Global variables
        let socket;
        let tempChart;
        let isConnected = false;
        let currentTemp = 0;
        let targetTemp = 0;
        let position = { x: 0, y: 0 };
        let motorStates = { x: 'MOTOR_DISABLED', y: 'MOTOR_DISABLED' };
        let pneumatics = { nozzle: false, stage: false, stamp: false };
        let vacuums = { vacnozzle: false, chuck: false };
        let tape = { speed: 0, torque: 0 };
        let tempData = [];
        let eStopTriggered = false;
        let currentEditingMacro = null;
        let macrosList = [];
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeChart();
            // Initialize all status indicators as red (inactive)
            updatePneumaticsDisplay();
            updateVacuumsDisplay();
            loadMacroList();
        });
        
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                updateConnectionStatus(true);
                addLog('Connected to server');
            });
            
            socket.on('disconnect', function() {
                updateConnectionStatus(false);
                addLog('Disconnected from server');
            });
            
            socket.on('connection_status', function(data) {
                updateConnectionStatus(data.connected);
            });
            
            socket.on('temperature_update', function(data) {
                currentTemp = data.temperature || 0;
                targetTemp = data.set_temperature || 0;
                updateTemperatureDisplay();
                updateTempChart();
            });
            
            socket.on('position_update', function(data) {
                position = data;
                updatePositionDisplay();
            });
            
            socket.on('motor_states_update', function(data) {
                motorStates = data;
                updateMotorStatesDisplay();
            });
            
            socket.on('pneumatics_update', function(data) {
                pneumatics = data;
                updatePneumaticsDisplay();
            });
            
            socket.on('vacuums_update', function(data) {
                vacuums = data;
                updateVacuumsDisplay();
            });
            
            socket.on('tape_update', function(data) {
                tape = data;
                updateTapeDisplay();
            });
            
            socket.on('estop_update', function(data) {
                eStopTriggered = data.triggered;
                updateEmergencyStopDisplay();
            });
            
            socket.on('command_sent', function(data) {
                addLog(`Sent: ${data.command}`);
            });
            
            socket.on('machine_response', function(data) {
                addLog(`Response: ${data.response}`);
            });
            
            socket.on('macro_list', function(data) {
                macrosList = data.macros || [];
                updateMacroList();
            });
            
            socket.on('macro_created', function(data) {
                addLog(`Macro created: ${data.name}`);
                loadMacroList();
            });
            
            socket.on('macro_deleted', function(data) {
                addLog(`Macro deleted: ${data.name}`);
                loadMacroList();
            });
            
            socket.on('macro_executed', function(data) {
                addLog(`Executing macro: ${data.name}`);
            });
            
            socket.on('macro_error', function(data) {
                addLog(`Macro error: ${data.error}`);
            });
        }
        
        function initializeChart() {
            const ctx = document.getElementById('tempChart').getContext('2d');
            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Current Temp',
                            data: [],
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: 'Target Temp',
                            data: [],
                            borderColor: '#F59E0B',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderDash: [5, 5],
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: '#374151' }
                        },
                        y: {
                            ticks: { color: 'white' },
                            grid: { color: '#374151' }
                        }
                    }
                }
            });
        }
        
        function updateConnectionStatus(connected) {
            isConnected = connected;
            const status = document.getElementById('connectionStatus');
            status.className = `status ${connected ? 'connected' : 'disconnected'}`;
            status.querySelector('span').textContent = connected ? 'Connected' : 'Disconnected';
        }
        
        function updateTemperatureDisplay() {
            document.getElementById('currentTemp').textContent = `${currentTemp}¬∞C`;
            document.getElementById('targetTemp').textContent = `${targetTemp}¬∞C`;
        }
        
        function updatePositionDisplay() {
            document.getElementById('posX').textContent = `${position.x} mm`;
            document.getElementById('posY').textContent = `${position.y} mm`;
        }
        
        function updateMotorStatesDisplay() {
            const stateClasses = {
                'MOTOR_DISABLED': 'state-disabled',
                'MOTOR_ENABLING': 'state-enabling', 
                'MOTOR_FAULTED': 'state-faulted',
                'MOTOR_READY': 'state-ready',
                'MOTOR_MOVING': 'state-moving'
            };
            
            Object.keys(motorStates).forEach(axis => {
                const stateEl = document.getElementById(`motorState${axis.toUpperCase()}`);
                if (stateEl) {
                    const state = motorStates[axis];
                    stateEl.textContent = state;
                    stateEl.className = `motor-state ${stateClasses[state] || 'state-disabled'}`;
                }
            });
        }
        
        function updatePneumaticsDisplay() {
            Object.keys(pneumatics).forEach(component => {
                const statusEl = document.getElementById(component + 'Status');
                if (statusEl) {
                    statusEl.className = `status-indicator ${pneumatics[component] ? 'active' : ''}`;
                }
            });
        }
        
        function updateVacuumsDisplay() {
            Object.keys(vacuums).forEach(component => {
                const statusEl = document.getElementById(component + 'Status');
                if (statusEl) {
                    statusEl.className = `status-indicator ${vacuums[component] ? 'active' : ''}`;
                }
            });
        }
        
        function updateTapeDisplay() {
            document.getElementById('currentTapeSpeed').textContent = tape.speed || 0;
            document.getElementById('currentTapeTorque').textContent = tape.torque || 0;
        }
        
        function updateEmergencyStopDisplay() {
            const emergencyButton = document.getElementById('emergencyButton');
            const restartMessage = document.getElementById('restartMessage');
            
            if (eStopTriggered) {
                emergencyButton.classList.add('estop-active');
                restartMessage.style.display = 'block';
            } else {
                emergencyButton.classList.remove('estop-active');
                restartMessage.style.display = 'none';
            }
        }
        
        function updateTempChart() {
            const now = new Date().toLocaleTimeString();
            
            if (tempChart.data.labels.length >= 20) {
                tempChart.data.labels.shift();
                tempChart.data.datasets[0].data.shift();
                tempChart.data.datasets[1].data.shift();
            }
            
            tempChart.data.labels.push(now);
            tempChart.data.datasets[0].data.push(currentTemp);
            tempChart.data.datasets[1].data.push(targetTemp);
            
            tempChart.update('none');
        }
        
        function addLog(message) {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const logLine = document.createElement('div');
            logLine.className = 'console-line';
            logLine.textContent = `[${timestamp}] ${message}`;
            console.appendChild(logLine);
            console.scrollTop = console.scrollHeight;
            
            while (console.children.length > 10) {
                console.removeChild(console.firstChild);
            }
        }
        
        // Macro functions
        function loadMacroList() {
            socket.emit('get_macros');
        }
        
        function updateMacroList() {
            const listContainer = document.getElementById('macroList');
            
            if (macrosList.length === 0) {
                listContainer.innerHTML = '<div style="color: #6B7280; text-align: center; padding: 20px;">No macros saved yet</div>';
                return;
            }
            
            listContainer.innerHTML = '';
            macrosList.forEach(macro => {
                const macroItem = document.createElement('div');
                macroItem.className = 'macro-item';
                macroItem.innerHTML = `
                    <span class="macro-name">${macro}</span>
                    <div class="macro-actions">
                        <button class="button btn-success" onclick="runMacro('${macro}')">Run</button>
                        <button class="button btn-warning" onclick="editMacro('${macro}')">Edit</button>
                        <button class="button btn-danger" onclick="deleteMacro('${macro}')">Delete</button>
                    </div>
                `;
                listContainer.appendChild(macroItem);
            });
        }
        
        function createNewMacro() {
            const name = document.getElementById('newMacroName').value.trim();
            if (!name) {
                addLog('Please enter a macro name');
                return;
            }
            
            currentEditingMacro = name;
            document.getElementById('editingMacroName').textContent = name;
            document.getElementById('macroContent').value = getMacroTemplate();
            openMacroEditor();
        }
        
        function getMacroTemplate() {
            return `# Macro: ${currentEditingMacro}
# Created: ${new Date().toLocaleString()}
# 
# Available Commands:
# - MoveX <position> or MoveX CHIP_X
# - MoveY <position> or MoveY CHIP_Y
# - EnableX / EnableY
# - DisableX / DisableY
# - ExtendNozzle / RetractNozzle
# - ExtendChipStage / RetractChipStage
# - ExtendStamp / RetractStamp
# - VacNozzleOn / VacNozzleOff
# - ChuckOn / ChuckOff
# - SetTemperature <temp>
# - Tape <speed> <torque> <time_ms>
# - StopTape
# - delay <milliseconds>
# - STOP (emergency stop)
#
# Variables:
# - CHIP_X, CHIP_Y, STAGE_X can be used in place of numeric values
#
# Example sequence:
# EnableX
# EnableY
# delay 500
# MoveX CHIP_X
# MoveY CHIP_Y
# delay 1000
# ExtendNozzle
# delay 500
# VacNozzleOn
# delay 1000
# RetractNozzle

# Your macro commands below:
`;
        }
        
        function openMacroEditor() {
            document.getElementById('overlay').classList.add('active');
            document.getElementById('macroEditor').classList.add('active');
        }
        
        function closeMacroEditor() {
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('macroEditor').classList.remove('active');
            currentEditingMacro = null;
        }
        
        function saveMacro() {
            if (!currentEditingMacro) return;
            
            const content = document.getElementById('macroContent').value;
            const variables = {
                CHIP_X: parseFloat(document.getElementById('CHIP_X').value),
                CHIP_Y: parseFloat(document.getElementById('CHIP_Y').value),
                STAGE_X: parseFloat(document.getElementById('STAGE_X').value)
            };
            
            socket.emit('save_macro', {
                name: currentEditingMacro,
                content: content,
                variables: variables
            });
            
            closeMacroEditor();
            document.getElementById('newMacroName').value = '';
        }
        
        function editMacro(name) {
            currentEditingMacro = name;
            document.getElementById('editingMacroName').textContent = name;
            
            socket.emit('load_macro', { name: name });
            socket.once('macro_content', function(data) {
                document.getElementById('macroContent').value = data.content || getMacroTemplate();
                openMacroEditor();
            });
        }
        
        function runMacro(name) {
            const variables = {
                CHIP_X: parseFloat(document.getElementById('CHIP_X').value),
                CHIP_Y: parseFloat(document.getElementById('CHIP_Y').value),
                STAGE_X: parseFloat(document.getElementById('STAGE_X').value)
            };
            
            socket.emit('run_macro', {
                name: name,
                variables: variables
            });
        }
        
        function deleteMacro(name) {
            if (confirm(`Are you sure you want to delete macro "${name}"?`)) {
                socket.emit('delete_macro', { name: name });
            }
        }
        
        // Control functions
        function enableAxis(axis) {
            socket.emit('enable_axis', { axis: axis });
        }
        
        function disableMotor(axis) {
            socket.emit('disable_motor', { axis: axis });
        }
        
        function moveToPosition(axis) {
            const inputId = axis.toLowerCase() + 'PositionInput';
            const position = parseFloat(document.getElementById(inputId).value);
            socket.emit('move_position', { axis: axis, position: position });
        }
        
        function controlPneumatic(component, action) {
            socket.emit('pneumatic_control', { component: component, action: action });
        }
        
        function controlVacuum(component, action) {
            socket.emit('vacuum_control', { component: component, action: action });
        }
        
        function setTemperature() {
            const temp = parseInt(document.getElementById('tempInput').value);
            socket.emit('set_temperature', { temperature: temp });
        }
        
        function emergencyStop() {
            socket.emit('emergency_stop');
        }
        
        function runTapeMotor() {
            const speed = parseInt(document.getElementById('tapeSpeed').value);
            const torque = parseInt(document.getElementById('tapeTorque').value);
            const time = parseInt(document.getElementById('tapeTime').value);
            socket.emit('tape_motor', { speed: speed, torque: torque, time: time });
        }
        
        function stopTapeMotor() {
            socket.emit('send_command', { command: 'StopTape' });
        }
        
        function sendCustomCommand() {
            const command = document.getElementById('customCommand').value;
            if (command.trim()) {
                socket.emit('send_command', { command: command });
                document.getElementById('customCommand').value = '';
            }
        }
        
        // Event listeners for Enter key
        document.getElementById('customCommand').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendCustomCommand();
        });
        
        [
            ['xPositionInput', () => moveToPosition('X')],
            ['yPositionInput', () => moveToPosition('Y')],
            ['tempInput', setTemperature],
            ['tapeSpeed', runTapeMotor],
            ['tapeTorque', runTapeMotor],
            ['tapeTime', runTapeMotor],
            ['newMacroName', createNewMacro]
        ].forEach(([id, fn]) => {
            document.getElementById(id).addEventListener('keypress', e => e.key === 'Enter' && fn());
        });
    </script>
</body>
</html>