<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exfoliator Control Interface</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #111827; color: white; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; min-height: 100vh; padding: 24px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .title { font-size: 2rem; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .status { padding: 8px 16px; border-radius: 8px; display: flex; align-items: center; gap: 8px; font-weight: 500; }
        .status.connected { background-color: #059669; }
        .status.disconnected { background-color: #DC2626; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: white; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; }
        .card { background-color: #1F2937; border-radius: 12px; padding: 24px; }
        .card-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .section-title { font-size: 1.125rem; font-weight: 500; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .button-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .button:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background-color: #2563EB; color: white; }
        .btn-secondary { background-color: #4B5563; color: white; }
        .btn-danger { background-color: #DC2626; color: white; }
        .btn-success { background-color: #059669; color: white; }
        .btn-emergency { background-color: #DC2626; color: white; font-size: 1.2rem; font-weight: bold; padding: 12px 24px; border: 3px solid #B91C1C; transition: all 0.3s ease; }
        .btn-emergency:hover { background-color: #B91C1C; transform: none; }
        .btn-emergency.estop-active { animation: flashRed 1s ease-in-out infinite alternate; }
        @keyframes flashRed { 0% { background-color: #DC2626; border-color: #B91C1C; box-shadow: 0 0 10px #DC2626; } 100% { background-color: #EF4444; border-color: #DC2626; box-shadow: 0 0 20px #EF4444; } }
        .emergency-container { display: flex; flex-direction: column; justify-content: center; align-items: center; margin-bottom: 24px; gap: 8px; }
        .restart-message { color: #EF4444; font-size: 1.1rem; font-weight: bold; text-align: center; animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .input { width: 100%; padding: 8px 12px; background-color: #374151; border: 1px solid #4B5563; border-radius: 6px; color: white; }
        .flex { display: flex; gap: 8px; align-items: center; }
        .flex-col { display: flex; flex-direction: column; gap: 8px; }
        .mb-4 { margin-bottom: 16px; } .mb-3 { margin-bottom: 12px; } .mb-2 { margin-bottom: 8px; }
        .temp-display { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .temp-current { font-size: 1.5rem; font-weight: bold; color: #EF4444; }
        .console { background-color: #000; border-radius: 6px; padding: 12px; height: 120px; overflow-y: auto; font-family: monospace; font-size: 0.875rem; }
        .console-line { color: #10B981; margin-bottom: 2px; }
        .chart-container { height: 250px; margin-bottom: 16px; }
        .pneumatic-control { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 12px; background-color: #374151; border-radius: 6px; }
        .pneumatic-status { display: flex; align-items: center; gap: 8px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; background-color: #DC2626; }
        .status-indicator.active { background-color: #10B981; }
        .motor-state { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-left: 8px; }
        .state-disabled { background-color: #6B7280; color: white; }
        .state-enabling { background-color: #F59E0B; color: white; }
        .state-faulted { background-color: #DC2626; color: white; }
        .state-ready { background-color: #059669; color: white; }
        .state-moving { background-color: #3B82F6; color: white; }
        .position-display { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 8px 12px; background-color: #374151; border-radius: 6px; }
        .tape-control-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
        .tape-input-group { display: flex; flex-direction: column; gap: 4px; }
        .tape-input-label { font-size: 0.875rem; color: #D1D5DB; }
        .tape-time-control { display: flex; gap: 8px; align-items: end; }
        .tape-time-input { flex: 1; }
        .tape-state-display { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 8px 12px; background-color: #374151; border-radius: 6px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; align-items: center; gap: 16px;">
                <h1 class="title"><span>üî¨</span> Exfoliator Control Interface</h1>
            </div>
            <div id="connectionStatus" class="status disconnected">
                <div class="status-dot"></div><span>Disconnected</span>
            </div>
        </div>

        <!-- Emergency Stop -->
        <div class="emergency-container">
            <button id="emergencyButton" class="button btn-emergency" onclick="emergencyStop()">üõë EMERGENCY STOP</button>
            <div id="restartMessage" class="restart-message" style="display: none;">‚ö†Ô∏è RESTART MACHINE ‚ö†Ô∏è</div>
        </div>

        <div class="grid">
            <!-- Position Controls -->
            <div class="card">
                <h2 class="card-title"><span>üìç</span> Position Control</h2>
                <div class="mb-4">
                    <h3 class="section-title">Current Position</h3>
                    <div class="position-display"><span>X Position:</span><div style="display: flex; align-items: center;"><span id="posX">0.0 mm</span><span id="motorStateX" class="motor-state state-disabled">MOTOR_DISABLED</span></div></div>
                    <div class="position-display"><span>Y Position:</span><div style="display: flex; align-items: center;"><span id="posY">0.0 mm</span><span id="motorStateY" class="motor-state state-disabled">MOTOR_DISABLED</span></div></div>
                </div>
                <div class="mb-4">
                    <h3 class="section-title"><span>üîå</span> Motor Enable</h3>
                    <div class="button-grid">
                        <button class="button btn-success" onclick="enableAxis('X')">Enable X</button>
                        <button class="button btn-success" onclick="enableAxis('Y')">Enable Y</button>
                        <button class="button btn-danger" onclick="disableMotor('X')">Disable X</button>
                        <button class="button btn-danger" onclick="disableMotor('Y')">Disable Y</button>
                    </div>
                </div>
                <div>
                    <h3 class="section-title">Move to Position</h3>
                    <div class="mb-3">
                        <label class="text-sm">X Position (mm)</label>
                        <input type="number" id="xPositionInput" class="input" value="0" step="0.1">
                        <button class="button btn-success mb-2" onclick="moveToPosition('X')">Move X</button>
                    </div>
                    <div class="mb-3">
                        <label class="text-sm">Y Position (mm)</label>
                        <input type="number" id="yPositionInput" class="input" value="0" step="0.1">
                        <button class="button btn-success" onclick="moveToPosition('Y')">Move Y</button>
                    </div>
                </div>
            </div>

            <!-- Pneumatics Control -->
            <div class="card">
                <h2 class="card-title"><span>üí®</span> Pneumatic Controls</h2>
                <div class="pneumatic-control"><div class="pneumatic-status"><div id="nozzleStatus" class="status-indicator"></div><span>Nozzle</span></div><div class="flex"><button class="button btn-success" onclick="controlPneumatic('nozzle', 'extend')">Extend</button><button class="button btn-danger" onclick="controlPneumatic('nozzle', 'retract')">Retract</button></div></div>
                <div class="pneumatic-control"><div class="pneumatic-status"><div id="stageStatus" class="status-indicator"></div><span>Chip Stage</span></div><div class="flex"><button class="button btn-success" onclick="controlPneumatic('stage', 'extend')">Extend</button><button class="button btn-danger" onclick="controlPneumatic('stage', 'retract')">Retract</button></div></div>
                <div class="pneumatic-control"><div class="pneumatic-status"><div id="stampStatus" class="status-indicator"></div><span>Stamp</span></div><div class="flex"><button class="button btn-success" onclick="controlPneumatic('stamp', 'extend')">Extend</button><button class="button btn-danger" onclick="controlPneumatic('stamp', 'retract')">Retract</button></div></div>
                <div>
                    <h3 class="section-title"><span>üå™Ô∏è</span> Vacuum Controls</h3>
                    <div class="pneumatic-control"><div class="pneumatic-status"><div id="vacnozzleStatus" class="status-indicator"></div><span>Nozzle</span></div><div class="flex"><button class="button btn-success" onclick="controlVacuum('vacnozzle', 'on')">On</button><button class="button btn-danger" onclick="controlVacuum('vacnozzle', 'off')">Off</button></div></div>
                    <div class="pneumatic-control"><div class="pneumatic-status"><div id="chuckStatus" class="status-indicator"></div><span>Chuck</span></div><div class="flex"><button class="button btn-success" onclick="controlVacuum('chuck', 'on')">On</button><button class="button btn-danger" onclick="controlVacuum('chuck', 'off')">Off</button></div></div>
                </div>
            </div>

            <!-- Tape Motor Control -->
            <div class="card">
                <h2 class="card-title"><span>üéûÔ∏è</span> Tape Motor Control</h2>
                <div class="mb-4">
                    <h3 class="section-title">Current State</h3>
                    <div class="tape-state-display"><span>Speed:</span><span id="currentTapeSpeed">0</span></div>
                    <div class="tape-state-display"><span>Torque:</span><span id="currentTapeTorque">0</span></div>
                </div>
                <div>
                    <h3 class="section-title">Set Parameters</h3>
                    <div class="tape-control-grid">
                        <div class="tape-input-group"><label class="tape-input-label">Speed</label><input type="number" id="tapeSpeed" class="input" value="0"></div>
                        <div class="tape-input-group"><label class="tape-input-label">Torque</label><input type="number" id="tapeTorque" class="input" value="0"></div>
                    </div>
                    <div class="tape-time-control">
                        <div class="tape-input-group tape-time-input"><label class="tape-input-label">Duration (ms)</label><input type="number" id="tapeTime" class="input" value="1000"></div>
                        <button class="button btn-primary" onclick="runTapeMotor()">Send Command</button>
                        <button class="button btn-danger" onclick="stopTapeMotor()">Stop Tape</button>
                    </div>
                </div>
            </div>

            <!-- Temperature Control -->
            <div class="card">
                <h2 class="card-title"><span>üå°Ô∏è</span> Chip Temperature Control</h2>
                <div class="temp-display mb-3"><span>Current Temperature:</span><span id="currentTemp" class="temp-current">0¬∞C</span></div>
                <div class="temp-display mb-3"><span>Target Temperature:</span><span id="targetTemp" class="temp-current" style="color: #F59E0B;">0¬∞C</span></div>
                <div class="flex mb-3"><input type="number" id="tempInput" class="input" value="25" min="0" max="200"><button class="button btn-danger" onclick="setTemperature()">Set Temp</button></div>
                <div class="chart-container"><canvas id="tempChart"></canvas></div>
            </div>

            <!-- Console -->
            <div class="card">
                <h2 class="card-title"><span>üíª</span> Console</h2>
                <div id="console" class="console"><div class="console-line">Machine control interface ready...</div></div>
                <div class="flex mt-3"><input type="text" id="customCommand" class="input" placeholder="Enter custom command..."><button class="button btn-primary" onclick="sendCustomCommand()">Send</button></div>
            </div>
        </div>
    </div>

    <script>
        let socket, tempChart, isConnected = false;
        let currentTemp = 0, targetTemp = 0;
        let position = { x: 0, y: 0 };
        let motorStates = { x: 'MOTOR_DISABLED', y: 'MOTOR_DISABLED' };
        let pneumatics = { nozzle: false, stage: false, stamp: false };
        let vacuums = { vacnozzle: false, chuck: false };
        let tape = { speed: 0, torque: 0 };
        let eStopTriggered = false;

        document.addEventListener('DOMContentLoaded', function () {
            initializeSocket();
            initializeChart();
            updatePneumaticsDisplay();
            updateVacuumsDisplay();
            // Attach enter-to-send
            addEnterSend('customCommand', sendCustomCommand);
            addEnterSend('tempInput', setTemperature);
            addEnterSend('tapeSpeed', runTapeMotor);
            addEnterSend('tapeTorque', runTapeMotor);
            addEnterSend('tapeTime', runTapeMotor);
            addEnterSend('xPositionInput', () => moveToPosition('X'));
            addEnterSend('yPositionInput', () => moveToPosition('Y'));
        });

        function addEnterSend(id, callback) {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    callback();
                }
            });
        }

        function initializeSocket() {
            socket = io();
