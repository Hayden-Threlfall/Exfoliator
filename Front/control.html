<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exfoliator Control Interface</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        function updateTemperatureDisplay() {
            document.getElementById('currentTemp').textContent = `${currentTemp}¬∞C`;
            document.getElementById('targetTemp').textContent = `${targetTemp}¬∞C`;
        }
        
        function updatePositionDisplay() {
            document.getElementById('posX').textContent = `${position.x} mm`;
            document.getElementById('posY').textContent = `${position.y} mm`;
        }
        
        function updateMotorStatesDisplay() {
            const stateClasses = {
                'MOTOR_DISABLED': 'state-disabled',
                'MOTOR_ENABLING': 'state-enabling', 
                'MOTOR_FAULTED': 'state-faulted',
                'MOTOR_READY': 'state-ready',
                'MOTOR_MOVING': 'state-moving'
            };
            
            Object.keys(motorStates).forEach(axis => {
                const stateEl = document.getElementById(`motorState${axis.toUpperCase()}`);
                if (stateEl) {
                    const state = motorStates[axis];
                    stateEl.textContent = state;
                    stateEl.className = `motor-state ${stateClasses[state] || 'state-disabled'}`;
                }
            });
        }
        
        function updatePneumaticsDisplay() {
            Object.keys(pneumatics).forEach(component => {
                const statusEl = document.getElementById(component + 'Status');
                if (statusEl) {
                    statusEl.className = `status-indicator ${pneumatics[component] ? 'active' : ''}`;
                }
            });
        }
        
        function updateVacuumsDisplay() {
            Object.keys(vacuums).forEach(component => {
                const statusEl = document.getElementById(component + 'Status');
                if (statusEl) {
                    statusEl.className = `status-indicator ${vacuums[component] ? 'active' : ''}`;
                }
            });
        }
        
        function updateTapeDisplay() {
            // Update tape motor input fields with current values
            document.getElementById('tapeSpeed').value = tape.speed || 0;
            document.getElementById('tapeTorque').value = tape.torque || 0;
        }* {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #111827;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            padding: 24px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .title {
            font-size: 2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status {
            padding: 8px 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .status.connected { background-color: #059669; }
        .status.disconnected { background-color: #DC2626; }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: white;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
        }
        
        .card {
            background-color: #1F2937;
            border-radius: 12px;
            padding: 24px;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title {
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .btn-primary { background-color: #2563EB; color: white; }
        .btn-secondary { background-color: #4B5563; color: white; }
        .btn-danger { background-color: #DC2626; color: white; }
        .btn-success { background-color: #059669; color: white; }
        .btn-emergency {
            background-color: #DC2626;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 12px 24px;
            border: 3px solid #B91C1C;
        }
        
        .btn-emergency:hover {
            background-color: #B91C1C;
            transform: none;
        }
        
        .emergency-container {
            display: flex;
            justify-content: center;
            margin-bottom: 24px;
        }
        
        .input {
            width: 100%;
            padding: 8px 12px;
            background-color: #374151;
            border: 1px solid #4B5563;
            border-radius: 6px;
            color: white;
        }
        
        .flex {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .flex-col {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .mb-4 { margin-bottom: 16px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-2 { margin-bottom: 8px; }
        
        .temp-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .temp-current {
            font-size: 1.5rem;
            font-weight: bold;
            color: #EF4444;
        }
        
        .console {
            background-color: #000;
            border-radius: 6px;
            padding: 12px;
            height: 120px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.875rem;
        }
        
        .console-line {
            color: #10B981;
            margin-bottom: 2px;
        }
        
        .chart-container {
            height: 250px;
            margin-bottom: 16px;
        }
        
        .pneumatic-control {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 12px;
            background-color: #374151;
            border-radius: 6px;
        }
        
        .pneumatic-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #DC2626;
        }
        
        .motor-state {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .state-disabled { background-color: #6B7280; color: white; }
        .state-enabling { background-color: #F59E0B; color: white; }
        .state-faulted { background-color: #DC2626; color: white; }
        .state-ready { background-color: #059669; color: white; }
        .state-moving { background-color: #3B82F6; color: white; }
        
        .position-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px 12px;
            background-color: #374151;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 class="title">
                <span>üî¨</span>
                Exfoliator Control Interface
            </h1>
            <div id="connectionStatus" class="status disconnected">
                <div class="status-dot"></div>
                <span>Disconnected</span>
            </div>
        </div>

        <!-- Emergency Stop -->
        <div class="emergency-container">
            <button class="button btn-emergency" onclick="emergencyStop()">üõë EMERGENCY STOP</button>
        </div>

        <div class="grid">
            <!-- Position Controls -->
            <div class="card">
                <h2 class="card-title">
                    <span>üìç</span>
                    Position Control
                </h2>
                
                <!-- Current Position -->
                <div class="mb-4">
                    <h3 class="section-title">Current Position</h3>
                    <div class="position-display">
                        <span>X Position:</span>
                        <div style="display: flex; align-items: center;">
                            <span id="posX">0.0 mm</span>
                            <span id="motorStateX" class="motor-state state-disabled">MOTOR_DISABLED</span>
                        </div>
                    </div>
                    <div class="position-display">
                        <span>Y Position:</span>
                        <div style="display: flex; align-items: center;">
                            <span id="posY">0.0 mm</span>
                            <span id="motorStateY" class="motor-state state-disabled">MOTOR_DISABLED</span>
                        </div>
                    </div>
                </div>
                
                <!-- Home Controls -->
                <div class="mb-4">
                    <h3 class="section-title">
                        <span>üè†</span>
                        Homing
                    </h3>
                    <div class="button-grid">
                        <button class="button btn-primary" onclick="homeAxis('')">Home All</button>
                        <button class="button btn-secondary" onclick="homeAxis('X')">Home X</button>
                        <button class="button btn-secondary" onclick="homeAxis('Y')">Home Y</button>
                        <button class="button btn-danger" onclick="disableMotor('X')">Disable X</button>
                        <button class="button btn-danger" onclick="disableMotor('Y')">Disable Y</button>
                    </div>
                </div>

                <!-- Move to Position -->
                <div>
                    <h3 class="section-title">Move to Position</h3>
                    <div class="mb-3">
                        <label class="text-sm">X Position (mm)</label>
                        <input type="number" id="xPositionInput" class="input" value="0" step="0.1">
                        <button class="button btn-success mb-2" onclick="moveToPosition('X')">Move X</button>
                    </div>
                    <div class="mb-3">
                        <label class="text-sm">Y Position (mm)</label>
                        <input type="number" id="yPositionInput" class="input" value="0" step="0.1">
                        <button class="button btn-success" onclick="moveToPosition('Y')">Move Y</button>
                    </div>
                </div>
            </div>

            <!-- Pneumatics Control -->
            <div class="card">
                <h2 class="card-title">
                    <span>üí®</span>
                    Pneumatic Controls
                </h2>
                
                <!-- Nozzle -->
                <div class="pneumatic-control">
                    <div class="pneumatic-status">
                        <div id="nozzleStatus" class="status-indicator"></div>
                        <span>Nozzle</span>
                    </div>
                    <div class="flex">
                        <button class="button btn-success" onclick="controlPneumatic('nozzle', 'extend')">Extend</button>
                        <button class="button btn-danger" onclick="controlPneumatic('nozzle', 'retract')">Retract</button>
                    </div>
                </div>

                <!-- Chip Stage -->
                <div class="pneumatic-control">
                    <div class="pneumatic-status">
                        <div id="stageStatus" class="status-indicator"></div>
                        <span>Chip Stage</span>
                    </div>
                    <div class="flex">
                        <button class="button btn-success" onclick="controlPneumatic('stage', 'extend')">Extend</button>
                        <button class="button btn-danger" onclick="controlPneumatic('stage', 'retract')">Retract</button>
                    </div>
                </div>

                <!-- Stamp -->
                <div class="pneumatic-control">
                    <div class="pneumatic-status">
                        <div id="stampStatus" class="status-indicator"></div>
                        <span>Stamp</span>
                    </div>
                    <div class="flex">
                        <button class="button btn-success" onclick="controlPneumatic('stamp', 'extend')">Extend</button>
                        <button class="button btn-danger" onclick="controlPneumatic('stamp', 'retract')">Retract</button>
                    </div>
                </div>

                <!-- Tape Motor -->
                <div class="mb-4">
                    <h3 class="section-title">
                        <span>üéûÔ∏è</span>
                        Tape Motor
                    </h3>
                    <div class="flex mb-2">
                        <input type="number" id="tapeSpeed" class="input" placeholder="Speed" value="100">
                        <label class="text-sm" style="white-space: nowrap; margin-right: 8px;">Speed</label>
                        <input type="number" id="tapeTorque" class="input" placeholder="Torque" value="50">
                        <label class="text-sm" style="white-space: nowrap;">Torque</label>
                    </div>
                    <div class="flex">
                        <input type="number" id="tapeTime" class="input" placeholder="Time (ms)" value="1000">
                        <label class="text-sm" style="white-space: nowrap; margin-right: 8px;">Time (ms)</label>
                        <button class="button btn-warning" onclick="runTapeMotor()">Run Tape</button>
                    </div>
                </div>

                <!-- Vacuum Controls -->
                <div>
                    <h3 class="section-title">
                        <span>üå™Ô∏è</span>
                        Vacuum Controls
                    </h3>
                    
                    <!-- Vacuum Nozzle -->
                    <div class="pneumatic-control">
                        <div class="pneumatic-status">
                            <div id="vacnozzleStatus" class="status-indicator"></div>
                            <span>Nozzle</span>
                        </div>
                        <div class="flex">
                            <button class="button btn-success" onclick="controlVacuum('vacnozzle', 'on')">On</button>
                            <button class="button btn-danger" onclick="controlVacuum('vacnozzle', 'off')">Off</button>
                        </div>
                    </div>

                    <!-- Chuck Vacuum -->
                    <div class="pneumatic-control">
                        <div class="pneumatic-status">
                            <div id="chuckStatus" class="status-indicator"></div>
                            <span>Chuck</span>
                        </div>
                        <div class="flex">
                            <button class="button btn-success" onclick="controlVacuum('chuck', 'on')">On</button>
                            <button class="button btn-danger" onclick="controlVacuum('chuck', 'off')">Off</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Temperature Control -->
            <div class="card">
                <h2 class="card-title">
                    <span>üå°Ô∏è</span>
                    Chip Temperature Control
                </h2>
                
                <div class="temp-display mb-3">
                    <span>Current Temperature:</span>
                    <span id="currentTemp" class="temp-current">0¬∞C</span>
                </div>
                
                <div class="temp-display mb-3">
                    <span>Target Temperature:</span>
                    <span id="targetTemp" class="temp-current" style="color: #F59E0B;">0¬∞C</span>
                </div>
                
                <div class="flex mb-3">
                    <input type="number" id="tempInput" class="input" value="25" min="0" max="200">
                    <button class="button btn-danger" onclick="setTemperature()">Set Temp</button>
                </div>

                <!-- Temperature Chart -->
                <div class="chart-container">
                    <canvas id="tempChart"></canvas>
                </div>
            </div>

            <!-- Console -->
            <div class="card">
                <h2 class="card-title">
                    <span>üíª</span>
                    Console
                </h2>
                <div id="console" class="console">
                    <div class="console-line">Machine control interface ready...</div>
                </div>
                
                <div class="flex mt-3">
                    <input type="text" id="customCommand" class="input" placeholder="Enter custom command...">
                    <button class="button btn-primary" onclick="sendCustomCommand()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let socket;
        let tempChart;
        let isConnected = false;
        let currentTemp = 0;
        let targetTemp = 0;
        let position = { x: 0, y: 0 };
        let motorStates = { x: 'MOTOR_DISABLED', y: 'MOTOR_DISABLED' };
        let pneumatics = { nozzle: false, stage: false, stamp: false };
        let vacuums = { vacnozzle: false, chuck: false };
        let tape = { speed: 0, torque: 0 };
        let tempData = [];
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeChart();
        });
        
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                updateConnectionStatus(true);
                addLog('Connected to server');
            });
            
            socket.on('disconnect', function() {
                updateConnectionStatus(false);
                addLog('Disconnected from server');
            });
            
            socket.on('connection_status', function(data) {
                updateConnectionStatus(data.connected);
            });
            
            socket.on('temperature_update', function(data) {
                currentTemp = data.temperature || 0;
                targetTemp = data.set_temperature || 0;
                updateTemperatureDisplay();
                updateTempChart();
            });
            
            socket.on('position_update', function(data) {
                position = data;
                updatePositionDisplay();
            });
            
            socket.on('motor_states_update', function(data) {
                motorStates = data;
                updateMotorStatesDisplay();
            });
            
            socket.on('pneumatics_update', function(data) {
                pneumatics = data;
                updatePneumaticsDisplay();
            });
            
            socket.on('vacuums_update', function(data) {
                vacuums = data;
                updateVacuumsDisplay();
            });
            
            socket.on('tape_update', function(data) {
                tape = data;
                updateTapeDisplay();
            });
            
            socket.on('command_sent', function(data) {
                addLog(`Sent: ${data.command}`);
            });
            
            socket.on('machine_response', function(data) {
                addLog(`Response: ${data.response}`);
            });
        }
        
        function initializeChart() {
            const ctx = document.getElementById('tempChart').getContext('2d');
            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Current Temp',
                            data: [],
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: 'Target Temp',
                            data: [],
                            borderColor: '#F59E0B',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderDash: [5, 5],
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: '#374151' }
                        },
                        y: {
                            ticks: { color: 'white' },
                            grid: { color: '#374151' }
                        }
                    }
                }
            });
        }
        
        function updateConnectionStatus(connected) {
            isConnected = connected;
            const status = document.getElementById('connectionStatus');
            status.className = `status ${connected ? 'connected' : 'disconnected'}`;
            status.querySelector('span').textContent = connected ? 'Connected' : 'Disconnected';
        }
        
        function updateTemperatureDisplay() {
            document.getElementById('currentTemp').textContent = `${currentTemp}¬∞C`;
            document.getElementById('targetTemp').textContent = `${targetTemp}¬∞C`;
        }
        
        function updatePositionDisplay() {
            document.getElementById('posX').textContent = `${position.x} mm`;
            document.getElementById('posY').textContent = `${position.y} mm`;
        }
        
        function updatePneumaticsDisplay() {
            Object.keys(pneumatics).forEach(component => {
                const statusEl = document.getElementById(component + 'Status');
                if (statusEl) {
                    statusEl.className = `status-indicator ${pneumatics[component] ? 'active' : ''}`;
                }
            });
        }
        
        function updateVacuumsDisplay() {
            Object.keys(vacuums).forEach(component => {
                const statusEl = document.getElementById(component + 'Status');
                if (statusEl) {
                    statusEl.className = `status-indicator ${vacuums[component] ? 'active' : ''}`;
                }
            });
        }
        
        function updateTapeDisplay() {
            // Update tape motor input fields with current values
            document.getElementById('tapeSpeed').value = tape.speed || 0;
            document.getElementById('tapeTorque').value = tape.torque || 0;
        }
        
        function updateTempChart() {
            const now = new Date().toLocaleTimeString();
            
            if (tempChart.data.labels.length >= 20) {
                tempChart.data.labels.shift();
                tempChart.data.datasets[0].data.shift();
                tempChart.data.datasets[1].data.shift();
            }
            
            tempChart.data.labels.push(now);
            tempChart.data.datasets[0].data.push(currentTemp);
            tempChart.data.datasets[1].data.push(targetTemp);
            
            tempChart.update('none');
        }
        
        function addLog(message) {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const logLine = document.createElement('div');
            logLine.className = 'console-line';
            logLine.textContent = `[${timestamp}] ${message}`;
            console.appendChild(logLine);
            console.scrollTop = console.scrollHeight;
            
            // Keep only last 10 lines
            while (console.children.length > 10) {
                console.removeChild(console.firstChild);
            }
        }
        
        function homeAxis(axis) {
            socket.emit('home_axis', { axis: axis });
        }
        
        function disableMotor(axis) {
            socket.emit('disable_motor', { axis: axis });
        }
        
        function moveToPosition(axis) {
            const inputId = axis.toLowerCase() + 'PositionInput';
            const position = parseFloat(document.getElementById(inputId).value);
            socket.emit('move_position', { axis: axis, position: position });
        }
        
        function controlPneumatic(component, action) {
            socket.emit('pneumatic_control', { component: component, action: action });
        }
        
        function controlVacuum(component, action) {
            socket.emit('vacuum_control', { component: component, action: action });
        }
        
        function setTemperature() {
            const temp = parseInt(document.getElementById('tempInput').value);
            socket.emit('set_temperature', { temperature: temp });
        }
        
        function emergencyStop() {
            socket.emit('emergency_stop');
        }
        
        function runTapeMotor() {
            const speed = parseInt(document.getElementById('tapeSpeed').value);
            const torque = parseInt(document.getElementById('tapeTorque').value);
            const time = parseInt(document.getElementById('tapeTime').value);
            socket.emit('tape_motor', { speed: speed, torque: torque, time: time });
        }
        
        function sendCustomCommand() {
            const command = document.getElementById('customCommand').value;
            if (command.trim()) {
                socket.emit('send_command', { command: command });
                document.getElementById('customCommand').value = '';
            }
        }
        
        // Allow Enter key to send custom commands
        document.getElementById('customCommand').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendCustomCommand();
            }
        });
    </script>
</body>
</html>