<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exfoliator Control Interface</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #111827;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            padding: 24px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .title {
            font-size: 2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status {
            padding: 8px 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .status.connected { background-color: #059669; }
        .status.disconnected { background-color: #DC2626; }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: white;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
        }
        
        .card {
            background-color: #1F2937;
            border-radius: 12px;
            padding: 24px;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title {
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .btn-primary { background-color: #2563EB; color: white; }
        .btn-secondary { background-color: #4B5563; color: white; }
        .btn-danger { background-color: #DC2626; color: white; }
        .btn-success { background-color: #059669; color: white; }
        .btn-emergency {
            background-color: #DC2626;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 12px 24px;
            border: 3px solid #B91C1C;
            transition: all 0.3s ease;
        }
        
        .btn-emergency:hover {
            background-color: #B91C1C;
            transform: none;
        }
        
        .btn-emergency.estop-active {
            animation: flashRed 1s ease-in-out infinite alternate;
        }
        
        @keyframes flashRed {
            0% { 
                background-color: #DC2626; 
                border-color: #B91C1C;
                box-shadow: 0 0 10px #DC2626;
            }
            100% { 
                background-color: #EF4444; 
                border-color: #DC2626;
                box-shadow: 0 0 20px #EF4444;
            }
        }
        
        .emergency-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 24px;
            gap: 8px;
        }
        
        .restart-message {
            color: #EF4444;
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .input {
            width: 100%;
            padding: 8px 12px;
            background-color: #374151;
            border: 1px solid #4B5563;
            border-radius: 6px;
            color: white;
        }
        
        .flex {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .flex-col {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .mb-4 { margin-bottom: 16px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-2 { margin-bottom: 8px; }
        
        .temp-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .temp-current {
            font-size: 1.5rem;
            font-weight: bold;
            color: #EF4444;
        }
        
        .console {
            background-color: #000;
            border-radius: 6px;
            padding: 12px;
            height: 120px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.875rem;
        }
        
        .console-line {
            color: #10B981;
            margin-bottom: 2px;
        }
        
        .chart-container {
            height: 250px;
            margin-bottom: 16px;
        }
        
        .pneumatic-control {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 12px;
            background-color: #374151;
            border-radius: 6px;
        }
        
        .pneumatic-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #DC2626;
        }
        
        .status-indicator.active {
            background-color: #10B981;
        }
        
        .motor-state {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .state-disabled { background-color: #6B7280; color: white; }
        .state-enabling { background-color: #F59E0B; color: white; }
        .state-faulted { background-color: #DC2626; color: white; }
        .state-ready { background-color: #059669; color: white; }
        .state-moving { background-color: #3B82F6; color: white; }
        
        .position-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px 12px;
            background-color: #374151;
            border-radius: 6px;
        }
        
        .tape-control-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .tape-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .tape-input-label {
            font-size: 0.875rem;
            color: #D1D5DB;
        }
        
        .tape-time-control {
            display: flex;
            gap: 8px;
            align-items: end;
        }
        
        .tape-time-input {
            flex: 1;
        }
        
        .tape-state-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px 12px;
            background-color: #374151;
            border-radius: 6px;
        }
        
        .debug-info {
            background-color: #1F2937;
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            font-family: monospace;
            font-size: 0.75rem;
            color: #9CA3AF;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; align-items: center; gap: 16px;">
                <h1 class="title">
                    Exfoliator Control Interface
                </h1>
            </div>
            <div id="connectionStatus" class="status disconnected">
                <div class="status-dot"></div>
                <span>Disconnected</span>
            </div>
        </div>

        <!-- Emergency Stop -->
        <div class="emergency-container">
            <button id="emergencyButton" class="button btn-emergency" onclick="emergencyStop()">EMERGENCY STOP</button>
            <div id="restartMessage" class="restart-message" style="display: none;">
                RESTART MACHINE
            </div>
        </div>

        <div class="grid">
            <!-- Position Controls -->
            <div class="card">
                <h2 class="card-title">
                    Position Control
                </h2>
                
                <!-- Current Position -->
                <div class="mb-4">
                    <h3 class="section-title">Current Position</h3>
                    <div class="position-display">
                        <span>X Position:</span>
                        <div style="display: flex; align-items: center;">
                            <span id="posX">0.0 mm</span>
                            <span id="motorStateX" class="motor-state state-disabled">MOTOR_DISABLED</span>
                        </div>
                    </div>
                    <div class="position-display">
                        <span>Y Position:</span>
                        <div style="display: flex; align-items: center;">
                            <span id="posY">0.0 mm</span>
                            <span id="motorStateY" class="motor-state state-disabled">MOTOR_DISABLED</span>
                        </div>
                    </div>
                </div>
                
                <!-- Enable Controls -->
                <div class="mb-4">
                    <h3 class="section-title">
                        Motor Enable
                    </h3>
                    <div class="button-grid">
                        <button class="button btn-success" onclick="enableAxis('X')">Enable X</button>
                        <button class="button btn-success" onclick="enableAxis('Y')">Enable Y</button>
                        <button class="button btn-danger" onclick="disableMotor('X')">Disable X</button>
                        <button class="button btn-danger" onclick="disableMotor('Y')">Disable Y</button>
                    </div>
                </div>

                <!-- Move to Position -->
                <div>
                    <h3 class="section-title">Move to Position</h3>
                    <div class="mb-3">
                        <label class="text-sm">X Position (mm)</label>
                        <input type="number" id="xPositionInput" class="input" value="0" step="0.1">
                        <button class="button btn-success mb-2" onclick="moveToPosition('X')">Move X</button>
                    </div>
                    <div class="mb-3">
                        <label class="text-sm">Y Position (mm)</label>
                        <input type="number" id="yPositionInput" class="input" value="0" step="0.1">
                        <button class="button btn-success" onclick="moveToPosition('Y')">Move Y</button>
                    </div>
                </div>
            </div>

            <!-- Pneumatics Control -->
            <div class="card">
                <h2 class="card-title">
                    Pneumatic Controls
                </h2>
                
                <!-- Nozzle -->
                <div class="pneumatic-control">
                    <div class="pneumatic-status">
                        <div id="nozzleStatus" class="status-indicator"></div>
                        <span>Nozzle</span>
                    </div>
                    <div class="flex">
                        <button class="button btn-success" onclick="controlPneumatic('nozzle', 'extend')">Extend</button>
                        <button class="button btn-danger" onclick="controlPneumatic('nozzle', 'retract')">Retract</button>
                    </div>
                </div>

                <!-- Chip Stage -->
                <div class="pneumatic-control">
                    <div class="pneumatic-status">
                        <div id="stageStatus" class="status-indicator"></div>
                        <span>Chip Stage</span>
                    </div>
                    <div class="flex">
                        <button class="button btn-success" onclick="controlPneumatic('stage', 'extend')">Extend</button>
                        <button class="button btn-danger" onclick="controlPneumatic('stage', 'retract')">Retract</button>
                    </div>
                </div>

                <!-- Stamp -->
                <div class="pneumatic-control">
                    <div class="pneumatic-status">
                        <div id="stampStatus" class="status-indicator"></div>
                        <span>Stamp</span>
                    </div>
                    <div class="flex">
                        <button class="button btn-success" onclick="controlPneumatic('stamp', 'extend')">Extend</button>
                        <button class="button btn-danger" onclick="controlPneumatic('stamp', 'retract')">Retract</button>
                    </div>
                </div>

                <!-- Vacuum Controls -->
                <div>
                    <h3 class="section-title">
                        Vacuum Controls
                    </h3>
                    
                    <!-- Vacuum Nozzle -->
                    <div class="pneumatic-control">
                        <div class="pneumatic-status">
                            <div id="vacnozzleStatus" class="status-indicator"></div>
                            <span>Nozzle</span>
                        </div>
                        <div class="flex">
                            <button class="button btn-success" onclick="controlVacuum('vacnozzle', 'on')">On</button>
                            <button class="button btn-danger" onclick="controlVacuum('vacnozzle', 'off')">Off</button>
                        </div>
                    </div>

                    <!-- Chuck Vacuum -->
                    <div class="pneumatic-control">
                        <div class="pneumatic-status">
                            <div id="chuckStatus" class="status-indicator"></div>
                            <span>Chuck</span>
                        </div>
                        <div class="flex">
                            <button class="button btn-success" onclick="controlVacuum('chuck', 'on')">On</button>
                            <button class="button btn-danger" onclick="controlVacuum('chuck', 'off')">Off</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tape Motor Control -->
            <div class="card">
                <h2 class="card-title">
                    Tape Motor Control
                </h2>
                
                <!-- Current Tape State -->
                <div class="mb-4">
                    <h3 class="section-title">Current State</h3>
                    <div class="tape-state-display">
                        <span>Speed:</span>
                        <span id="currentTapeSpeed">0</span>
                    </div>
                    <div class="tape-state-display">
                        <span>Torque:</span>
                        <span id="currentTapeTorque">0</span>
                    </div>
                </div>

                <!-- Tape Motor Controls -->
                <div>
                    <h3 class="section-title">Set Parameters</h3>
                    <div class="tape-control-grid">
                        <div class="tape-input-group">
                            <label class="tape-input-label">Speed</label>
                            <input type="number" id="tapeSpeed" class="input" value="0">
                        </div>
                        <div class="tape-input-group">
                            <label class="tape-input-label">Torque</label>
                            <input type="number" id="tapeTorque" class="input" value="0">
                        </div>
                    </div>
                    <div class="tape-time-control">
                        <div class="tape-input-group tape-time-input">
                            <label class="tape-input-label">Duration (ms)</label>
                            <input type="number" id="tapeTime" class="input" value="1000">
                        </div>
                        <button class="button btn-primary" onclick="runTapeMotor()">Send Command</button>
                        <button class="button btn-danger" onclick="stopTapeMotor()">Stop Tape</button>
                    </div>
                </div>
            </div>

            <!-- Temperature Control -->
            <div class="card">
                <h2 class="card-title">
                    Chip Temperature Control
                </h2>
                
                <div class="temp-display mb-3">
                    <span>Current Temperature:</span>
                    <span id="currentTemp" class="temp-current">0°C</span>
                </div>
                
                <div class="temp-display mb-3">
                    <span>Target Temperature:</span>
                    <span id="targetTemp" class="temp-current" style="color: #F59E0B;">0°C</span>
                </div>
                
                <div class="flex mb-3">
                    <input type="number" id="tempInput" class="input" value="25" min="0" max="200">
                    <button class="button btn-danger" onclick="setTemperature()">Set Temp</button>
                </div>

                <!-- Temperature Chart -->
                <div class="chart-container">
                    <canvas id="tempChart"></canvas>
                </div>
            </div>

            <!-- Console -->
            <div class="card">
                <h2 class="card-title">
                    Console
                </h2>
                <div id="console" class="console">
                    <div class="console-line">Machine control interface ready...</div>
                </div>
                
                <div class="flex mt-3">
                    <input type="text" id="customCommand" class="input" placeholder="Enter custom command...">
                    <button class="button btn-primary" onclick="sendCustomCommand()">Send</button>
                </div>
                
                <!-- Debug Info -->
                <div class="debug-info">
                    <div>Last Update: <span id="lastUpdate">Never</span></div>
                    <div>Socket Status: <span id="socketStatus">Initializing</span></div>
                    <div>Updates Received: <span id="updateCount">0</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let socket;
        let tempChart;
        let isConnected = false;
        let currentTemp = 0;
        let targetTemp = 0;
        let position = { x: 0, y: 0 };
        let motorStates = { x: 'MOTOR_DISABLED', y: 'MOTOR_DISABLED' };
        let pneumatics = { nozzle: false, stage: false, stamp: false };
        let vacuums = { vacnozzle: false, chuck: false };
        let tape = { speed: 0, torque: 0 };
        let tempData = [];
        let eStopTriggered = false;
        let updateCount = 0;
        let lastUpdateTime = 0;
        let updateThrottle = 100; // Minimum ms between UI updates
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let isReconnecting = false;
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            addLog('Initializing application...');
            initializeSocket();
            initializeChart();
            // Initialize all status indicators as red (inactive)
            updatePneumaticsDisplay();
            updateVacuumsDisplay();
            updateDebugInfo();
        });
        
        function initializeSocket() {
            addLog('Connecting to server...');
            document.getElementById('socketStatus').textContent = 'Connecting...';
            
            // Clean up existing socket if it exists
            if (socket) {
                socket.removeAllListeners();
                socket.disconnect();
            }
            
            socket = io({
                timeout: 5000,
                forceNew: true,
                reconnection: true,
                reconnectionAttempts: maxReconnectAttempts,
                reconnectionDelay: 1000
            });
            
            socket.on('connect', function() {
                addLog('Connected to server');
                document.getElementById('socketStatus').textContent = 'Connected';
                updateConnectionStatus(true);
                reconnectAttempts = 0;
                isReconnecting = false;
            });
            
            socket.on('disconnect', function() {
                addLog('Disconnected from server');
                document.getElementById('socketStatus').textContent = 'Disconnected';
                updateConnectionStatus(false);
                
                if (!isReconnecting && reconnectAttempts < maxReconnectAttempts) {
                    isReconnecting = true;
                    setTimeout(() => {
                        reconnectAttempts++;
                        addLog(`Reconnection attempt ${reconnectAttempts}/${maxReconnectAttempts}`);
                        initializeSocket();
                    }, 2000);
                }
            });
            
            socket.on('connection_status', function(data) {
                throttledUpdate(() => {
                    addLog(`Arduino connection: ${data.connected ? 'Connected' : 'Disconnected'}`);
                    updateConnectionStatus(data.connected);
                });
            });
            
            socket.on('temperature_update', function(data) {
                throttledUpdate(() => {
                    addLog(`Temp update: ${data.temperature}°C (target: ${data.set_temperature}°C)`);
                    currentTemp = parseFloat(data.temperature) || 0;
                    targetTemp = parseFloat(data.set_temperature) || 0;
                    updateTemperatureDisplay();
                    updateTempChart();
                });
            });
            
            socket.on('position_update', function(data) {
                throttledUpdate(() => {
                    addLog(`Position update: X=${data.x}, Y=${data.y}`);
                    position.x = parseFloat(data.x) || 0;
                    position.y = parseFloat(data.y) || 0;
                    updatePositionDisplay();
                });
            });
            
            socket.on('motor_states_update', function(data) {
                throttledUpdate(() => {
                    addLog(`Motor states: X=${data.x}, Y=${data.y}`);
                    motorStates = { ...data };
                    updateMotorStatesDisplay();
                });
            });
            
            socket.on('pneumatics_update', function(data) {
                throttledUpdate(() => {
                    addLog(`Pneumatics: nozzle=${data.nozzle}, stage=${data.stage}, stamp=${data.stamp}`);
                    pneumatics = { ...data };
                    updatePneumaticsDisplay();
                });
            });
            
            socket.on('vacuums_update', function(data) {
                throttledUpdate(() => {
                    addLog(`Vacuums: nozzle=${data.vacnozzle}, chuck=${data.chuck}`);
                    vacuums = { ...data };
                    updateVacuumsDisplay();
                });
            });
            
            socket.on('tape_update', function(data) {
                // Update tape data without logging to reduce console spam
                throttledUpdate(() => {
                    tape = { ...data };
                    updateTapeDisplay();
                });
            });
            
            socket.on('estop_update', function(data) {
                throttledUpdate(() => {
                    addLog(`E-Stop: ${data.triggered ? 'TRIGGERED' : 'Normal'}`);
                    eStopTriggered = Boolean(data.triggered);
                    updateEmergencyStopDisplay();
                });
            });
            
            socket.on('command_sent', function(data) {
                addLog(`Sent: ${data.command} (${data.status})`);
            });
            
            socket.on('machine_response', function(data) {
                addLog(`Response: ${data.response}`);
            });
            
            // Add error handlers
            socket.on('connect_error', function(error) {
                addLog(`Connection error: ${error.message || error}`);
                document.getElementById('socketStatus').textContent = 'Error';
            });
            
            socket.on('error', function(error) {
                addLog(`Socket error: ${error.message || error}`);
            });
            
            socket.on('reconnect', function(attemptNumber) {
                addLog(`Reconnected after ${attemptNumber} attempts`);
                reconnectAttempts = 0;
                isReconnecting = false;
            });
            
            socket.on('reconnect_failed', function() {
                addLog(`Failed to reconnect after ${maxReconnectAttempts} attempts`);
                isReconnecting = false;
                document.getElementById('socketStatus').textContent = 'Connection Failed';
            });
        }
        
        function initializeChart() {
            const ctx = document.getElementById('tempChart').getContext('2d');
            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Current Temp',
                            data: [],
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: 'Target Temp',
                            data: [],
                            borderColor: '#F59E0B',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderDash: [5, 5],
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: '#374151' }
                        },
                        y: {
                            ticks: { color: 'white' },
                            grid: { color: '#374151' }
                        }
                    }
                }
            });
        }
        
        function throttledUpdate(callback) {
            const now = Date.now();
            if (now - lastUpdateTime >= updateThrottle) {
                lastUpdateTime = now;
                updateCount++;
                requestAnimationFrame(() => {
                    callback();
                    updateDebugInfo();
                });
            }
        }
        
        function updateConnectionStatus(connected) {
            isConnected = connected;
            const status = document.getElementById('connectionStatus');
            if (status) {
                status.className = `status ${connected ? 'connected' : 'disconnected'}`;
                const span = status.querySelector('span');
                if (span) span.textContent = connected ? 'Connected' : 'Disconnected';
            }
        }
        
        function updateTemperatureDisplay() {
            const currentTempEl = document.getElementById('currentTemp');
            const targetTempEl = document.getElementById('targetTemp');
            
            if (currentTempEl) currentTempEl.textContent = `${currentTemp.toFixed(1)}°C`;
            if (targetTempEl) targetTempEl.textContent = `${targetTemp.toFixed(1)}°C`;
        }
        
        function updatePositionDisplay() {
            const posXEl = document.getElementById('posX');
            const posYEl = document.getElementById('posY');
            
            if (posXEl) posXEl.textContent = `${position.x.toFixed(2)} mm`;
            if (posYEl) posYEl.textContent = `${position.y.toFixed(2)} mm`;
        }
        
        function updateMotorStatesDisplay() {
            const stateClasses = {
                'MOTOR_DISABLED': 'state-disabled',
                'MOTOR_ENABLING': 'state-enabling', 
                'MOTOR_FAULTED': 'state-faulted',
                'MOTOR_READY': 'state-ready',
                'MOTOR_MOVING': 'state-moving'
            };
            
            ['x', 'y'].forEach(axis => {
                const stateEl = document.getElementById(`motorState${axis.toUpperCase()}`);
                if (stateEl && motorStates[axis]) {
                    const state = motorStates[axis];
                    stateEl.textContent = state;
                    // Remove all state classes
                    Object.values(stateClasses).forEach(cls => stateEl.classList.remove(cls));
                    // Add current state class
                    const stateClass = stateClasses[state] || 'state-disabled';
                    stateEl.className = `motor-state ${stateClass}`;
                }
            });
        }
        
        function updatePneumaticsDisplay() {
            ['nozzle', 'stage', 'stamp'].forEach(component => {
                const statusEl = document.getElementById(component + 'Status');
                if (statusEl) {
                    const isActive = pneumatics[component] || false;
                    statusEl.className = `status-indicator ${isActive ? 'active' : ''}`;
                }
            });
        }
        
        function updateVacuumsDisplay() {
            ['vacnozzle', 'chuck'].forEach(component => {
                const statusEl = document.getElementById(component + 'Status');
                if (statusEl) {
                    const isActive = vacuums[component] || false;
                    statusEl.className = `status-indicator ${isActive ? 'active' : ''}`;
                }
            });
        }
        
        function updateTapeDisplay() {
            const speedEl = document.getElementById('currentTapeSpeed');
            const torqueEl = document.getElementById('currentTapeTorque');
            
            if (speedEl) speedEl.textContent = tape.speed || 0;
            if (torqueEl) torqueEl.textContent = tape.torque || 0;
        }
        
        function updateEmergencyStopDisplay() {
            const emergencyButton = document.getElementById('emergencyButton');
            const restartMessage = document.getElementById('restartMessage');
            
            if (emergencyButton && restartMessage) {
                if (eStopTriggered) {
                    emergencyButton.classList.add('estop-active');
                    restartMessage.style.display = 'block';
                } else {
                    emergencyButton.classList.remove('estop-active');
                    restartMessage.style.display = 'none';
                }
            }
        }
        
        function updateTempChart() {
            if (!tempChart) return;
            
            try {
                const now = new Date().toLocaleTimeString();
                
                if (tempChart.data.labels.length >= 20) {
                    tempChart.data.labels.shift();
                    tempChart.data.datasets[0].data.shift();
                    tempChart.data.datasets[1].data.shift();
                }
                
                tempChart.data.labels.push(now);
                tempChart.data.datasets[0].data.push(currentTemp);
                tempChart.data.datasets[1].data.push(targetTemp);
                
                tempChart.update('none');
            } catch (error) {
                console.error('Error updating temperature chart:', error);
            }
        }
        
        function updateDebugInfo() {
            const lastUpdateEl = document.getElementById('lastUpdate');
            const updateCountEl = document.getElementById('updateCount');
            
            if (lastUpdateEl) lastUpdateEl.textContent = new Date().toLocaleTimeString();
            if (updateCountEl) updateCountEl.textContent = updateCount;
        }
        
        function addLog(message) {
            try {
                const console = document.getElementById('console');
                if (!console) return;
                
                const timestamp = new Date().toLocaleTimeString();
                const logLine = document.createElement('div');
                logLine.className = 'console-line';
                logLine.textContent = `[${timestamp}] ${message}`;
                console.appendChild(logLine);
                console.scrollTop = console.scrollHeight;
                
                // Keep only last 10 lines
                while (console.children.length > 10) {
                    console.removeChild(console.firstChild);
                }
            } catch (error) {
                console.error('Error adding log:', error);
            }
        }
        
        function safeEmit(event, data) {
            if (socket && socket.connected) {
                try {
                    socket.emit(event, data);
                    return true;
                } catch (error) {
                    addLog(`Error sending command: ${error.message}`);
                    return false;
                }
            } else {
                addLog('Cannot send command - not connected');
                return false;
            }
        }
        
        function enableAxis(axis) {
            safeEmit('enable_axis', { axis: axis });
        }
        
        function disableMotor(axis) {
            safeEmit('disable_motor', { axis: axis });
        }
        
        function moveToPosition(axis) {
            const inputId = axis.toLowerCase() + 'PositionInput';
            const positionInput = document.getElementById(inputId);
            if (!positionInput) return;
            
            const position = parseFloat(positionInput.value);
            if (isNaN(position)) {
                addLog(`Invalid position value: ${positionInput.value}`);
                return;
            }
            
            safeEmit('move_position', { axis: axis, position: position });
        }
        
        function controlPneumatic(component, action) {
            safeEmit('pneumatic_control', { component: component, action: action });
        }
        
        function controlVacuum(component, action) {
            safeEmit('vacuum_control', { component: component, action: action });
        }
        
        function setTemperature() {
            const tempInput = document.getElementById('tempInput');
            if (!tempInput) return;
            
            const temp = parseInt(tempInput.value);
            if (isNaN(temp)) {
                addLog(`Invalid temperature value: ${tempInput.value}`);
                return;
            }
            
            safeEmit('set_temperature', { temperature: temp });
        }
        
        function emergencyStop() {
            safeEmit('emergency_stop');
        }
        
        function runTapeMotor() {
            const speedInput = document.getElementById('tapeSpeed');
            const torqueInput = document.getElementById('tapeTorque');
            const timeInput = document.getElementById('tapeTime');
            
            if (!speedInput || !torqueInput || !timeInput) return;
            
            const speed = parseInt(speedInput.value);
            const torque = parseInt(torqueInput.value);
            const time = parseInt(timeInput.value);
            
            if (isNaN(speed) || isNaN(torque) || isNaN(time)) {
                addLog('Invalid tape motor values');
                return;
            }
            
            safeEmit('tape_motor', { speed: speed, torque: torque, time: time });
        }

        function stopTapeMotor() {
            safeEmit('send_command', { command: 'StopTape' });
        }
        
        function sendCustomCommand() {
            const commandInput = document.getElementById('customCommand');
            if (!commandInput) return;
            
            const command = commandInput.value;
            if (command.trim()) {
                safeEmit('send_command', { command: command });
                commandInput.value = '';
            }
        }
        
        // Allow Enter key to send custom commands
        document.getElementById('customCommand').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendCustomCommand();
            }
        });
    </script>
</body>
</html>